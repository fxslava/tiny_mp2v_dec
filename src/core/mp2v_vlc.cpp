// Copyright © 2021 Vladislav Ovchinnikov. All rights reserved.
#include "mp2v_vlc.h"
#include "common/cpu.h"

//ISO/IEC 13818-2 : 2000 (E) Annex B - Variable length code tables. B.1 Macroblock addressing
vlc_t macroblock_address_increment_to_vlc[35] = {
    { 0b0, 0 },           // 0 , val: none
    // nlz 0
    { 0b1, 1 },           // 1 , val: 1
    // nlz 1
    { 0b011, 3 },         // 2 , val: 3
    { 0b010, 3 },         // 3 , val: 2
    // nlz 2
    { 0b0011, 4 },        // 4 , val: 3
    { 0b0010, 4 },        // 5 , val: 2
    // nlz 3
    { 0b00011, 5 },       // 6 , val: 3
    { 0b00010, 5 },       // 7 , val: 2
    // nlz 4
    { 0b0000111, 7 },     // 8 , val: 7
    { 0b0000110, 7 },     // 9 , val: 6
    // nlz 4
    { 0b00001011, 8 },    // 10, val: 11
    { 0b00001010, 8 },    // 11, val: 10
    { 0b00001001, 8 },    // 12, val: 9
    { 0b00001000, 8 },    // 13, val: 8
    // nlz 5
    { 0b00000111, 8 },    // 14, val: 7
    { 0b00000110, 8 },    // 15, val: 6
    // nlz 5
    { 0b0000010111, 10 },  // 16, val: 23
    { 0b0000010110, 10 },  // 17, val: 22
    { 0b0000010101, 10 },  // 18, val: 21
    { 0b0000010100, 10 },  // 19, val: 20
    { 0b0000010011, 10 },  // 20, val: 19
    { 0b0000010010, 10 },  // 21, val: 18
    // nlz 5
    { 0b00000100011, 11 }, // 22, val: 35
    { 0b00000100010, 11 }, // 23, val: 34
    { 0b00000100001, 11 }, // 24, val: 33
    { 0b00000100000, 11 }, // 25, val: 32
    // nlz 6
    { 0b00000011111, 11 }, // 26, val: 31
    { 0b00000011110, 11 }, // 27, val: 30
    { 0b00000011101, 11 }, // 28, val: 29
    { 0b00000011100, 11 }, // 29, val: 28
    { 0b00000011011, 11 }, // 30, val: 27
    { 0b00000011010, 11 }, // 31, val: 26
    { 0b00000011001, 11 }, // 32, val: 25
    { 0b00000011000, 11 }, // 33, val: 24
    vlc_macroblock_escape_code
};

int32_t get_macroblock_address_increment(bitstream_reader_i* bs) {
    uint32_t buffer = bs->get_next_bits(32);
    int nlz = bit_scan_reverse(buffer);
    switch (nlz) {
    case 0: return bs->read_next_bits(1);
    case 1: return 5  - bs->read_next_bits(3);
    case 2: return 7  - bs->read_next_bits(4);
    case 3: return 9  - bs->read_next_bits(5);
    case 4:
        if (buffer > 0x0B000000)
            return 15 - bs->read_next_bits(7);
        else
            return 21 - bs->read_next_bits(8);
    case 5:
        if (buffer > 0x05C00000)
            return 21 - bs->read_next_bits(8);
        else if (buffer > 0x04600000)
            return 39 - bs->read_next_bits(10);
        else
            return 57 - bs->read_next_bits(11);
    case 6: return 57 - bs->read_next_bits(11);
    }
    return 0; // invalid address increment
}

macroblock_type_vlc_t i_macroblock_type[2] = {
    { 0b1,      1, 0b000010},//0x80
    { 0b01,     2, 0b100010}
};

macroblock_type_vlc_t p_macroblock_type[7] = {
    { 0b1,      1, 0b010100 },//0x80
    { 0b01,     2, 0b000100 },//0x40
    { 0b001,    3, 0b010000 },//0x20
    { 0b00011,  5, 0b000010 },
    { 0b00010,  5, 0b110100 },
    { 0b00001,  5, 0b100100 },//0x08
    { 0b000001, 6, 0b100010 }
};

macroblock_type_vlc_t b_macroblock_type[11] = {
    { 0b11,     2, 0b011100 },
    { 0b10,     2, 0b011000 }, //0x80
    { 0b011,    3, 0b001100 },
    { 0b010,    3, 0b001000 }, //0x40
    { 0b0011,   4, 0b010100 },
    { 0b0010,   4, 0b010000 }, //0x20
    { 0b00011,  5, 0b000010 },
    { 0b00010,  5, 0b111100 }, //0x10
    { 0b000011, 6, 0b110100 },
    { 0b000010, 6, 0b101100 },
    { 0b000001, 6, 0b100010 }
};
                                    //-,        1,        2,        3,
uint8_t p_macroblock_type_0x08[5] = { 0,        0b100100, 0b110100, 0b000010 };
uint8_t b_macroblock_type_0x80[4] = { 0,        0,        0b011000, 0b011100 };
uint8_t b_macroblock_type_0x40[4] = { 0,        0,        0b001000, 0b001100 };
uint8_t b_macroblock_type_0x20[4] = { 0,        0,        0b010000, 0b010100 };
uint8_t b_macroblock_type_0x10[4] = { 0,        0,        0b111100, 0b000010 };
uint8_t b_macroblock_type_else[5] = { 0,        0b100010, 0b101100, 0b110100 };

uint8_t get_macroblock_type(bitstream_reader_i* bs, int picture_coding_type) {
    uint8_t buffer = (uint8_t)bs->get_next_bits(8);
    if (picture_coding_type == 1) {// I
        if (buffer >= 0x80) return 0b000010;
        else                return 0b100010;
    }
    if (picture_coding_type == 2) {// P
        if (buffer >= 0x80) { bs->skip_bits(1);  return 0b010100; } else
        if (buffer >= 0x40) { bs->skip_bits(2);  return 0b000100; } else
        if (buffer >= 0x20) { bs->skip_bits(3);  return 0b010000; } else
        if (buffer >= 0x08) return p_macroblock_type_0x08[bs->read_next_bits(5)]; else { 
         bs->skip_bits(6);  return 0b100010; }
    }
    if (picture_coding_type == 3) {// B
        if (buffer >= 0x80) return b_macroblock_type_0x80[bs->read_next_bits(2)]; else
        if (buffer >= 0x40) return b_macroblock_type_0x40[bs->read_next_bits(3)]; else
        if (buffer >= 0x20) return b_macroblock_type_0x20[bs->read_next_bits(4)]; else
        if (buffer >= 0x10) return b_macroblock_type_0x10[bs->read_next_bits(5)];
        else                return b_macroblock_type_else[bs->read_next_bits(6)];
    }
    return true;
}

macroblock_type_vlc_t ss_i_macroblock_type[5] = {
    { 0b1,         1, 0b000100 }, //0x80
    { 0b01,        2, 0b100100 }, //0x40
    { 0b0011,      4, 0b000010 },
    { 0b0010,      4, 0b100010 },
    { 0b0001,      4, 0b000000 }
};

macroblock_type_vlc_t ss_p_macroblock_type[16] = {
    { 0b11,        2, 0b110101 },
    { 0b10,        2, 0b010100 }, //0x80
    { 0b011,       3, 0b010101 },
    { 0b010,       3, 0b110100 }, //0x40
    { 0b0011,      4, 0b010001 },
    { 0b0010,      4, 0b010000 }, //0x20
    { 0b000111,    6, 0b000101 },
    { 0b000110,    6, 0b000001 },
    { 0b000101,    6, 0b100101 },
    { 0b000100,    6, 0b100100 }, //0x10
    { 0b0000111,   7, 0b000010 },
    { 0b0000110,   7, 0b100010 },
    { 0b0000101,   7, 0b000100 },
    { 0b0000100,   7, 0b000100 }, //0x08
    { 0b0000011,   7, 0b000000 },
    { 0b0000010,   7, 0b100100 }
};

macroblock_type_vlc_t ss_b_macroblock_type[20] = {
    { 0b11,        2, 0b011100 },
    { 0b10,        2, 0b011000 }, //0x80
    { 0b011,       3, 0b001100 },
    { 0b010,       3, 0b001000 }, //0x40
    { 0b0011,      4, 0b010100 },
    { 0b0010,      4, 0b010000 }, //0x20
    { 0b000111,    6, 0b001101 },
    { 0b000110,    6, 0b001001 },
    { 0b000101,    6, 0b010101 },
    { 0b000100,    6, 0b010001 }, //0x10
    { 0b0000111,   7, 0b111100 },
    { 0b0000110,   7, 0b000010 },
    { 0b0000101,   7, 0b101100 },
    { 0b0000100,   7, 0b110100 }, //0x08
    { 0b000001111, 9, 0b000100 },
    { 0b000001110, 9, 0b000000 },
    { 0b000001101, 9, 0b100100 },
    { 0b000001100, 9, 0b101101 }, //0x06
    { 0b00000101,  8, 0b110101 },
    { 0b00000100,  8, 0b100010 }
    //else 9bit
};

                                       //-,        1,        2,        3
uint8_t ss_i_macroblock_type_else[4] = { 0,        0b000000, 0b100010, 0b000010 };
uint8_t ss_p_macroblock_type_0x80[4] = { 0,        0,        0b010100, 0b110101 };
uint8_t ss_p_macroblock_type_0x40[4] = { 0,        0,        0b110100, 0b010101 };
uint8_t ss_p_macroblock_type_0x20[4] = { 0,        0,        0b010000, 0b010001 };
                                       //4,        5,        6,        7
uint8_t ss_p_macroblock_type_0x10[8] = { 0b100100, 0b100101, 0b000001, 0b000101 };
                                       //-,        1,        2,        3,        4,        5,        6,        7
uint8_t ss_p_macroblock_type_else[8] = { 0,        0,        0b100100, 0b000000, 0b000100, 0b000100, 0b100010, 0b000010 };
                                       //-,        1,        2,        3
uint8_t ss_b_macroblock_type_0x80[4] = { 0,        0,        0b011000, 0b011100 };
uint8_t ss_b_macroblock_type_0x40[4] = { 0,        0,        0b001000, 0b001100 };
uint8_t ss_b_macroblock_type_0x20[4] = { 0,        0,        0b010000, 0b010100 };
                                       //4,        5,        6,        7
uint8_t ss_b_macroblock_type_0x10[4] = { 0b010001, 0b010101, 0b001001, 0b001101 };
uint8_t ss_b_macroblock_type_0x08[4] = { 0b110100, 0b101100, 0b000010, 0b111100 };
                                       //12,       13,       14,       15
uint8_t ss_b_macroblock_type_0x06[4] = { 0b101101, 0b100100, 0b000000, 0b000100 };
                                       //4,        5,        6,        7
uint8_t ss_b_macroblock_type_else[4] = { 0b100010, 0b110101, 0,        0 };

uint8_t get_spatial_scalability_macroblock_type(bitstream_reader_i* bs, int picture_coding_type) {
    if (picture_coding_type == 1) {// Intra
        uint8_t buffer = (uint8_t)bs->get_next_bits(8);
        if (buffer >= 0x80) { bs->skip_bits(1); return 0b000100; } else
        if (buffer >= 0x40) { bs->skip_bits(2); return 0b100100; } else
            return ss_i_macroblock_type_else[bs->read_next_bits(4)];
    }
    if (picture_coding_type == 2) {// Pred
        uint8_t buffer = (uint8_t)bs->get_next_bits(8);
        if (buffer >= 0x80) return ss_p_macroblock_type_0x80[bs->read_next_bits(2)]; else
        if (buffer >= 0x40) return ss_p_macroblock_type_0x40[bs->read_next_bits(3)]; else
        if (buffer >= 0x20) return ss_p_macroblock_type_0x20[bs->read_next_bits(4)]; else
        if (buffer >= 0x10) return ss_p_macroblock_type_0x10[bs->read_next_bits(6) - 4]; else
            return ss_p_macroblock_type_else[bs->read_next_bits(7)];
    }
    if (picture_coding_type == 3) {// Bidir
        uint8_t buffer = (uint8_t)bs->get_next_bits(8);
        if (buffer >= 0x80) return ss_b_macroblock_type_0x80[bs->read_next_bits(2)]; else
        if (buffer >= 0x40) return ss_b_macroblock_type_0x40[bs->read_next_bits(3)]; else
        if (buffer >= 0x20) return ss_b_macroblock_type_0x20[bs->read_next_bits(4)]; else
        if (buffer >= 0x10) return ss_b_macroblock_type_0x10[bs->read_next_bits(6) - 4]; else
        if (buffer >= 0x08) return ss_b_macroblock_type_0x08[bs->read_next_bits(7) - 4]; else
        if (buffer >= 0x06) return ss_b_macroblock_type_0x06[bs->read_next_bits(9) -12]; else
            return ss_b_macroblock_type_else[bs->read_next_bits(8) - 4];
    }
    return true;
}

macroblock_type_vlc_t snr_macroblock_type[3] = {
    { 0b1,   1, 0b000100 }, //0x80
    { 0b01,  2, 0b100100 },
    { 0b001, 3, 0b000000 }
};

uint8_t get_snr_scalability_macroblock_type(bitstream_reader_i* bs, int picture_coding_type) {
    uint8_t buffer = (uint8_t)bs->get_next_bits(2);
    if (buffer >= 2) return 0b000100;
    if (buffer >= 1) return 0b100100;
    return 0b000000;
}

//ISO/IEC 13818-2 : 2000 (E) Annex B - Variable length code tables. B.9 Macroblock pattern
vlc_t coded_block_pattern_to_vlc[64] = {
    {0b000000001, 9 },    {0b01011,     5 },    {0b01001,     5 },    {0b001101,    6 },
    {0b1101,      4 },    {0b0010111,   7 },    {0b0010011,   7 },    {0b00011111,  8 },
    {0b1100,      4 },    {0b0010110,   7 },    {0b0010010,   7 },    {0b00011110,  8 },
    {0b10011,     5 },    {0b00011011,  8 },    {0b00010111,  8 },    {0b00010011,  8 },
    {0b1011,      4 },    {0b0010101,   7 },    {0b0010001,   7 },    {0b00011101,  8 },
    {0b10001,     5 },    {0b00011001,  8 },    {0b00010101,  8 },    {0b00010001,  8 },
    {0b001111,    6 },    {0b00001111,  8 },    {0b00001101,  8 },    {0b000000011, 9 },
    {0b01111,     5 },    {0b00001011,  8 },    {0b00000111,  8 },    {0b000000111, 9 },
    {0b1010,      4 },    {0b0010100,   7 },    {0b0010000,   7 },    {0b00011100,  8 },
    {0b001110,    6 },    {0b00001110,  8 },    {0b00001100,  8 },    {0b000000010, 9 },
    {0b10000,     5 },    {0b00011000,  8 },    {0b00010100,  8 },    {0b00010000,  8 },
    {0b01110,     5 },    {0b00001010,  8 },    {0b00000110,  8 },    {0b000000110, 9 },
    {0b10010,     5 },    {0b00011010,  8 },    {0b00010110,  8 },    {0b00010010,  8 },
    {0b01101,     5 },    {0b00001001,  8 },    {0b00000101,  8 },    {0b000000101, 9 },
    {0b01100,     5 },    {0b00001000,  8 },    {0b00000100,  8 },    {0b000000100, 9 },
    {0b111,       3 },    {0b01010,     5 },    {0b01000,     5 },    {0b001100,    6 },
};

struct vlc_value_t {
    int8_t vlc_len;
    int8_t value;
};

vlc_value_t vlc_cbp[9][32] = {
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 5, 40 }, { 5, 20 }, { 5, 48 }, { 5, 12 }, { 4, 32 }, { 4, 32 }, { 4, 16 }, { 4, 16 }, 
      { 4,  8 }, { 4,  8 }, { 4,  4 }, { 4,  4 }, { 3, 60 }, { 3, 60 }, { 3, 60 }, { 3, 60 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 5, 62 }, { 5, 62 }, { 5,  2 }, { 5,  2 }, { 5, 61 }, { 5, 61 }, { 5,  1 }, { 5,  1 }, 
      { 5, 56 }, { 5, 56 }, { 5, 52 }, { 5, 52 }, { 5, 44 }, { 5, 44 }, { 5, 28 }, { 5, 28 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 7, 34 }, { 7, 18 }, { 7, 10 }, { 7,  6 }, { 7, 33 }, { 7, 17 }, { 7,  9 }, { 7,  5 }, 
      { 6, 63 }, { 6, 63 }, { 6,  3 }, { 6,  3 }, { 6, 36 }, { 6, 36 }, { 6, 24 }, { 6, 24 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 8, 43 }, { 8, 23 }, { 8, 51 }, { 8, 15 }, { 8, 42 }, { 8, 22 }, { 8, 50 }, { 8, 14 }, 
      { 8, 41 }, { 8, 21 }, { 8, 49 }, { 8, 13 }, { 8, 35 }, { 8, 19 }, { 8, 11 }, { 8,  7 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 8, 57 }, { 8, 57 }, { 8, 53 }, { 8, 53 }, { 8, 45 }, { 8, 45 }, { 8, 29 }, { 8, 29 }, 
      { 8, 38 }, { 8, 38 }, { 8, 26 }, { 8, 26 }, { 8, 37 }, { 8, 37 }, { 8, 25 }, { 8, 25 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 8, 58 }, { 8, 58 }, { 8, 58 }, { 8, 58 }, { 8, 54 }, { 8, 54 }, { 8, 54 }, { 8, 54 }, 
      { 8, 46 }, { 8, 46 }, { 8, 46 }, { 8, 46 }, { 8, 30 }, { 8, 30 }, { 8, 30 }, { 8, 30 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 9, 59 }, { 9, 59 }, { 9, 59 }, { 9, 59 }, { 9, 55 }, { 9, 55 }, { 9, 55 }, { 9, 55 }, 
      { 9, 47 }, { 9, 47 }, { 9, 47 }, { 9, 47 }, { 9, 31 }, { 9, 31 }, { 9, 31 }, { 9, 31 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 9, 39 }, { 9, 39 }, { 9, 39 }, { 9, 39 }, { 9, 39 }, { 9, 39 }, { 9, 39 }, { 9, 39 }, 
      { 9, 27 }, { 9, 27 }, { 9, 27 }, { 9, 27 }, { 9, 27 }, { 9, 27 }, { 9, 27 }, { 9, 27 }, },
    { { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, { 0,  0 }, 
      { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, 
      { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, { 9,  0 }, },
};

int32_t get_coded_block_pattern(bitstream_reader_i* bs) {
    uint32_t buffer = bs->get_next_bits(32);
    int nlz = bit_scan_reverse(buffer);
    int idx = buffer >> (32 - nlz - 5);
    int val = vlc_cbp[nlz][idx].value;
    bs->skip_bits(vlc_cbp[nlz][idx].vlc_len);
    return val;
}

//ISO/IEC 13818-2 : 2000 (E) Annex B - B.4 Motion vectors. B.10 Table
vlc_t motion_code_to_vlc[33] = {
    { 0b00000011001, 11 }, // -16
    { 0b00000011011, 11 }, // -15
    { 0b00000011101, 11 }, // -14
    { 0b00000011111, 11 }, // -13
    { 0b00000100001, 11 }, // -12
    { 0b00000100011, 11 }, // -11
    { 0b0000010011 , 10 }, // -10
    { 0b0000010101 , 10 }, //  -9
    { 0b0000010111 , 10 }, //  -8
    { 0b00000111   ,  8 }, //  -7
    { 0b00001001   ,  8 }, //  -6
    { 0b00001011   ,  8 }, //  -5
    { 0b0000111    ,  7 }, //  -4
    { 0b00011      ,  5 }, //  -3
    { 0b0011       ,  4 }, //  -2
    { 0b011        ,  3 }, //  -1
    { 0b1          ,  1 }, //   0
    { 0b010        ,  3 }, //   1
    { 0b0010       ,  4 }, //   2
    { 0b00010      ,  5 }, //   3
    { 0b0000110    ,  7 }, //   4
    { 0b00001010   ,  8 }, //   5
    { 0b00001000   ,  8 }, //   6
    { 0b00000110   ,  8 }, //   7
    { 0b0000010110 , 10 }, //   8
    { 0b0000010100 , 10 }, //   9
    { 0b0000010010 , 10 }, //  10
    { 0b00000100010, 11 }, //  11
    { 0b00000100000, 11 }, //  12
    { 0b00000011110, 11 }, //  13
    { 0b00000011100, 11 }, //  14
    { 0b00000011010, 11 }, //  15
    { 0b00000011000, 11 }  //  16
};

vlc_value_t vlc_motion_code[7][64] = {
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 },
    {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 },
    {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 },
    {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, {  1,   0 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 },
    {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 }, {  3,   1 },
    {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 },
    {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, {  3,  -1 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 },
    {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 }, {  4,   2 },
    {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 },
    {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, {  4,  -2 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 },
    {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 }, {  5,   3 },
    {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 },
    {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, {  5,  -3 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  8,   6 }, {  8,   6 }, {  8,   6 }, {  8,   6 }, {  8,  -6 }, {  8,  -6 }, {  8,  -6 }, {  8,  -6 },
    {  8,   5 }, {  8,   5 }, {  8,   5 }, {  8,   5 }, {  8,  -5 }, {  8,  -5 }, {  8,  -5 }, {  8,  -5 },
    {  7,   4 }, {  7,   4 }, {  7,   4 }, {  7,   4 }, {  7,   4 }, {  7,   4 }, {  7,   4 }, {  7,   4 },
    {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, {  7,  -4 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    { 11,  12 }, { 11, -12 }, { 11,  11 }, { 11, -11 }, { 10,  10 }, { 10,  10 }, { 10, -10 }, { 10, -10 },
    { 10,   9 }, { 10,   9 }, { 10,  -9 }, { 10,  -9 }, { 10,   8 }, { 10,   8 }, { 10,  -8 }, { 10,  -8 },
    {  8,   7 }, {  8,   7 }, {  8,   7 }, {  8,   7 }, {  8,   7 }, {  8,   7 }, {  8,   7 }, {  8,   7 },
    {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, {  8,  -7 }, },
  { {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 }, {  0,   0 },
    { 11,  16 }, { 11,  16 }, { 11, -16 }, { 11, -16 }, { 11,  15 }, { 11,  15 }, { 11, -15 }, { 11, -15 },
    { 11,  14 }, { 11,  14 }, { 11, -14 }, { 11, -14 }, { 11,  13 }, { 11,  13 }, { 11, -13 }, { 11, -13 }, }
};

int32_t get_motion_code(bitstream_reader_i* bs) {
    uint32_t buffer = bs->get_next_bits(32);
    int nlz = bit_scan_reverse(buffer);
    int idx = buffer >> (32 - nlz - 6);
    int val = vlc_motion_code[nlz][idx].value;
    bs->skip_bits(vlc_motion_code[nlz][idx].vlc_len);
    return val;
}

//ISO/IEC 13818-2 : 2000 (E) Annex B - B.4 Motion vectors. B.11 Table.
vlc_t dmvector_to_vlc[3] = {
    { 0b11, 2}, // -1
    { 0b0,  1}, //  0
    { 0b10, 2}, //  1
};

int32_t get_dmvector(bitstream_reader_i* bs) {
    int buffer = bs->get_next_bits(2);
    switch (buffer) {
    case 3: 
        bs->skip_bits(2); return -1;
    case 0:
    case 1: 
        bs->skip_bits(1); return 0;
    case 2:
        bs->skip_bits(2); return 1;
    }
    return 0;
}

//ISO/IEC 13818-2 : 2000 (E) Annex B - B.5 DCT coefficients. B.12 Table.
vlc_t dct_size_luminance_to_vlc[12] = {
    { 0b100, 0 },
    { 0b00, 1 },
    { 0b01, 2 },
    { 0b101, 3 },
    { 0b110, 4 },
    { 0b1110, 5 },
    { 0b11110, 6 },
    { 0b111110, 7 },
    { 0b1111110, 8 },
    { 0b11111110, 9 },
    { 0b111111110, 10 },
    { 0b111111111, 11 }
};

//ISO/IEC 13818-2 : 2000 (E) Annex B - B.5 DCT coefficients. B.13 Table.
vlc_t dct_size_chrominance_to_vlc[12] = {
    { 0b00, 0 },
    { 0b01, 1 },
    { 0b10, 2 },
    { 0b110, 3 },
    { 0b1110, 4 },
    { 0b11110, 5 },
    { 0b111110, 6 },
    { 0b1111110, 7 },
    { 0b11111110, 8 },
    { 0b111111110, 9 },
    { 0b1111111110, 10 },
    { 0b1111111111, 11 }
};